# 12.2 하드웨어에서의 효율성과 일관성
물리 머신에서의 동시성 문제는 가상 머신의 동시성 문제와 비슷하다.

따라서 물리 머신의 해법이 가상 머신을 구현할 때도 도움이 되는 일이 많다.

### 공유 메모리 멀티프로세서 시스템 (물리 머신)

- 컴퓨터 작업은 단순 프로세서의 연산만으로 이루어져 있지 않으므로 성능을 최대한 끌어올리기 쉽지 않다.
- 프로세서는 데이터를 읽고 그 결과를 저장해야 하므로 메모리 I/O 가 필요하다.
- 프로세서와 메모리 속도의 격차 문제 해결
    - 캐시 계층을 둔다.
    - 데이터를 캐시에 복사하여 작업을 빨리 수행하고, 작업이 완료되면 결과 데이터를 메모리로 동기화한다.
- 캐시 계층이 낳는 문제
    - 컴퓨터 시스템이 그만큼 복잡해져 ‘**캐시 일관성**’ 이라는 새로운 문제를 야기한다.
    - 멀티프로세서 시스템은 각각 캐시를 갖춘 채 똑같은 메인 메모리를 공유한다.
    - 이러한 시스템을 ‘공유 메모리 멀티프로세서 시스템’ 이라고 한다.
    - 여러 프로세서가 메인 메모리의 같은 영역을 보고 작업해도, 프로세서별 캐시 데이터는 다를 수 있다.
    - 이때 데이터를 메인 메모리로 동기화할 때 어느 프로세서의 데이터를 기준으로 삼아야할까
- 일관성 문제 해결
    - 프로세서들은 캐시를 이용할 때 정해진 **캐시 일관성 프로토콜**을 따라야 한다.
    - 대표적인 프로토콜로는 MSI, MESI, MOSI, 시냅스, 파이어플라이, 드래곤 프로토콜 등이 있다.
    - **메모리 모델**은 이 특정 프로토콜을 이용하여 특정 메모리나 캐시를 읽고 쓰는 절차를 말한다.
    - 아키텍처가 다른 물리 머신은 서로 메모리 모델도 다르다.
    - JVM은 물리 머신의 메모리 및 캐시 접근 방식과 매우 비슷한 자체 메모리 모델을 가진다.

### 비순차 실행 최적화(out-of-order execution optimization)

- 캐시 방식 외에도 프로세서의 컴퓨팅 능력을 끌어올릴 수 있는 방법으로 비순차 실행 최적화 방식이 있다.
- 비순차 실행이란 프로세서가 명령어를 실행하는 순서가 코드 상에 기술된 순서와 다르다는 것이다.
- 프로세서는 이렇게 비순차 실행 후 물론 실행 결과가 순차 실행했을 때와 같게 재구성한다.
- **JVM의 JIT 컴파일러는 이와 비슷하게 명령어 재정렬이라는 최적화를 수행한다.**
